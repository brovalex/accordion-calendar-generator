<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"> 
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<script src="./date_fns.min.js"></script>
</head>
<body>
<a href="#" download="file.svg" id="downloadLink" style="position:fixed;right:20px;top:20px;padding:8px 16px;background-color:navy;color:white;border-radius: 3px; text-decoration: none;">Download</a>
<div id="svgwrap"><svg id="mySVG" vertsion="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" style="width:10px;height:10px"/></svg></div>
<script>
// svg stuff
var svgNS = "http://www.w3.org/2000/svg"
// settings:
page_w = 550
page_h = 350
padding_x = 5
padding_y = 6
// INPUTS
var start = {year: 2018, month: 12} // 1 = january
var number_of_months = 14
var weekStartsOn = 1 // Monday
// PREP
var start_date = new Date(start.year, start.month-1, 1)
var end_date = dateFns.lastDayOfMonth(dateFns.addMonths(start_date,number_of_months-1))


// NEW OUTPUT
var calStart = dateFns.startOfWeek(start_date,{weekStartsOn:weekStartsOn})
var calEnd   = dateFns.endOfWeek(end_date,{weekStartsOn:weekStartsOn})

var calDays = dateFns.eachDay(calStart, calEnd)
var calWeeks = ((days) => {
	calWeeks = []
	while (days.length) {
		calWeeks.push(days.splice(0, 7));
	}
	return calWeeks
})(calDays)
var calPages = ((weeks) => {
	calPages = []
	calPages[0] = []
	var i = 0, j=0
	while (i < weeks.length) {
		// if day0 > day6 (e.g. 28 > 4) then it's last week of month which is carried over to next month
		isLastWeek = dateFns.getDate(weeks[i][0]) > dateFns.getDate(weeks[i][6])
		// if day0 is on 1st OR if last week but not first or last week then next page
		if(dateFns.isFirstDayOfMonth(weeks[i][0]) || (isLastWeek && i!=0 && i!=weeks.length-1)) {
			j+=1
			calPages[j]=[]
		}
		calPages[j].push(weeks[i])
		i++
	}
	return calPages
})(calWeeks)

console.log(calPages)


// OLD

var weeks_total = 1+dateFns.differenceInCalendarWeeks(
	end_date,
  start_date,
  {weekStartsOn:weekStartsOn}
)
var lastWeekCheck = (d0,d6) => {
		// if last week of month, give last day; else first day
		// flip arguments for reverse: if last week give first day; else last day
		return dateFns.getDate(d0) > dateFns.getDate(d6) ? d6 : d0
}
var daysOfWeek = [...Array(7).keys()].map((d)=>{return dateFns.format(dateFns.addDays(dateFns.startOfWeek(start_date,{weekStartsOn:weekStartsOn}),d),'ddd')})
// var monthsOfYear = [...Array(12).keys()].map((m)=>{return dateFns.format(dateFns.addMonths(new Date(1988, 0, 21),m),'MMMM')})


// functions
var writeDay = (d,x,y) => {
	let dayText = document.createElementNS(svgNS,'text')
	dayText.setAttributeNS(null,"x",x)
	dayText.setAttributeNS(null,"y",y+12) // manual adjustment for height of text
	dayText.setAttributeNS(null,"text-anchor","end")
	// dayText.setAttributeNS(null,"alignment-baseline","hanging")
	let textNode = document.createTextNode(d)
	dayText.appendChild(textNode)
	document.getElementById("mySVG").appendChild(dayText)
}
var writeDays = (days,m,n,wks) => {
	h = page_h / wks
	days.forEach((d,j)=>{
		writeDay(dateFns.format(d,'D'),(j+1)*page_w/7-padding_x,m*page_h+n*h+padding_y)
	})
}
var writeDaysOfWeek = (m) => {
	daysOfWeek.forEach((d,j)=>{
		let dayText = document.createElementNS(svgNS,'text')
		dayText.setAttributeNS(null,"x",j*page_w/7+padding_x)
		dayText.setAttributeNS(null,"y",m*page_h+padding_y+12) // manual adjustment for height of text
		dayText.setAttributeNS(null,"text-anchor","start")
		let textNode = document.createTextNode(d)
		dayText.appendChild(textNode)
		document.getElementById("mySVG").appendChild(dayText)
	})
}
var drawWeekline = (m,n,wks) => {
	h = page_h / wks
	let rect = document.createElementNS(svgNS,'rect')
	rect.setAttributeNS(null, 'x', padding_x);
	rect.setAttributeNS(null, 'y', m*page_h+(n+1)*h);
	rect.setAttributeNS(null, 'height', '1');
	rect.setAttributeNS(null, 'width', page_w);
	rect.setAttributeNS(null, 'fill', n+1==wks?'pink':'grey')
	document.getElementById("mySVG").appendChild(rect)
}
var writeMonthHeader = (m,mmmm,wks) => {
	h = page_h / wks
	let monthText = document.createElementNS(svgNS,'text')
	monthText.setAttributeNS(null,"x",padding_x)
	monthText.setAttributeNS(null,"y",m*page_h+h-padding_y) // manual adjustment for height of text
	monthText.setAttributeNS(null,"text-anchor","start")
	monthText.setAttributeNS(null,"font-size","36px")
	let textNode = document.createTextNode(mmmm)
	monthText.appendChild(textNode)
	document.getElementById("mySVG").appendChild(monthText)
}
var writeWeekNumber = (w,m,n,wks) => {
	h = page_h / wks
	let weekText = document.createElementNS(svgNS,'text')
		weekText.setAttributeNS(null,"x",padding_x)
		weekText.setAttributeNS(null,"y",m*page_h+(n+1)*h-padding_y) // manual adjustment for height of text
		weekText.setAttributeNS(null,"text-anchor","start")
		let textNode = document.createTextNode( (n==1?"Week ":"") + w)
		weekText.appendChild(textNode)
		document.getElementById("mySVG").appendChild(weekText)
}
// OUTPUT
for (let i=0;i<weeks_total;i++) {
	// prep
	let first_day_i = dateFns.startOfWeek(dateFns.addWeeks(start_date,i),{weekStartsOn:weekStartsOn})
	let days_i = dateFns.eachDay(first_day_i, dateFns.lastDayOfWeek(first_day_i,{weekStartsOn:weekStartsOn}))
	let nWeekOfMonth = dateFns.differenceInCalendarWeeks(days_i[6],dateFns.startOfMonth(days_i[6]),{weekStartsOn:weekStartsOn})
	let isLastMonth = dateFns.differenceInMonths(lastWeekCheck(days_i[6],days_i[0]), start_date) >= number_of_months-1
	let isFirstMonth = dateFns.differenceInMonths(lastWeekCheck(days_i[0],days_i[6]), start_date) == 0
	let dayOfThisMonth = lastWeekCheck(days_i[6],days_i[0])
	if ( isFirstMonth ) {
		var weeksCount_i = dateFns.differenceInCalendarWeeks(dateFns.lastDayOfMonth(days_i[6]),dateFns.startOfWeek(dateFns.startOfMonth(days_i[6]),{weekStartsOn:weekStartsOn}),{weekStartsOn:weekStartsOn})
		var m_i = 0
	} else if ( isLastMonth ) {
		// last MONTH
		var weeksCount_i = Math.ceil((1+dateFns.differenceInDays(dateFns.lastDayOfMonth(dayOfThisMonth),dateFns.startOfMonth(dayOfThisMonth))+(7+dateFns.getDay(dateFns.startOfMonth(dayOfThisMonth))-weekStartsOn)%7)/7)
		// var weeksCount_i = 1 + dateFns.differenceInCalendarWeeks(dateFns.lastDayOfMonth(lastWeekCheck(days_i[6],days_i[0])),dateFns.startOfMonth(days_i[0]),{weekStartsOn:weekStartsOn})
		var m_i = dateFns.differenceInMonths(end_date,start_date)
		if(i == weeks_total-1) {
			nWeekOfMonth = dateFns.differenceInCalendarWeeks(dateFns.addWeeks(days_i[6],0),dateFns.startOfMonth(days_i[0]),{weekStartsOn:weekStartsOn})
		}
	} else {
		var weeksCount_i = Math.floor((1+dateFns.differenceInDays(dateFns.lastDayOfMonth(dayOfThisMonth),dateFns.startOfMonth(dayOfThisMonth))+(7+dateFns.getDay(dateFns.startOfMonth(dayOfThisMonth))-weekStartsOn)%7)/7)
		var m_i = dateFns.differenceInMonths(days_i[6],start_date)
	}
	// check if new month for header, make exception for very last week
	if (nWeekOfMonth == 0) {
		writeDaysOfWeek(m_i)
		if(i != weeks_total-1) {
			writeMonthHeader(m_i, dateFns.format(days_i[6],'MMMM'), weeksCount_i)
		}
	} else {
		// add week number if not first week
		writeWeekNumber(dateFns.getISOWeek(days_i[3]),m_i,nWeekOfMonth,weeksCount_i)
	}
	// console.log({isLastMonth,days_i,fd:days_i[0],m_i,nWeekOfMonth,weeksCount_i})
	writeDays(days_i,m_i,nWeekOfMonth,weeksCount_i)
	drawWeekline(m_i,nWeekOfMonth,weeksCount_i)
}
// formatting stuff
document.getElementById("mySVG").style.width=page_w
document.getElementById("mySVG").style.height=number_of_months*page_h+1
//
var svgSrc = new XMLSerializer().serializeToString(document.getElementsByTagName( 'svg' )[ 0 ]);
document.getElementById("downloadLink").setAttribute('href', 'data:image/svg+xml;utf8,' + encodeURIComponent(svgSrc));
</script>

</body>

</html>